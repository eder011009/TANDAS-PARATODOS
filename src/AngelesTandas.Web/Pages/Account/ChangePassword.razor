@page "/account/change-password"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@inject UserManager<AngelesTandas.Infrastructure.Identity.ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<div class="container mt-5">
    <h2>üîê Cambiar Contrase√±a</h2>

    <div class="card" style="max-width: 500px;">
        <div class="card-body">
            <EditForm Model="@model" OnValidSubmit="@ChangePasswordHandler">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Contrase√±a Actual</label>
                    <input type="password" class="form-control" @bind="model.CurrentPassword" />
                    <small class="text-muted">Requerida: 12+ caracteres, may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos especiales</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nueva Contrase√±a</label>
                    <input type="password" class="form-control" @bind="model.NewPassword" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Confirmar Nueva Contrase√±a</label>
                    <input type="password" class="form-control" @bind="model.ConfirmPassword" />
                </div>

                <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span>Cambiando...</span>
                    }
                    else
                    {
                        <span>‚úì Cambiar Contrase√±a</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mt-3">
            @message
        </div>
    }
</div>

@code {
    private ChangePasswordModel model = new();
    private bool isProcessing = false;
    private string? message;
    private bool isSuccess = false;

    private async Task ChangePasswordHandler()
    {
        isProcessing = true;
        message = null;
        isSuccess = false;

        try
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = auth.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                message = "‚ùå Usuario no autenticado";
                return;
            }

            var user = await UserManager.FindByIdAsync(userId);
            if (user == null)
            {
                message = "‚ùå Usuario no encontrado";
                return;
            }

            var result = await UserManager.ChangePasswordAsync(user, model.CurrentPassword, model.NewPassword);
            
            if (result.Succeeded)
            {
                message = "‚úì Contrase√±a cambiada exitosamente";
                isSuccess = true;
                model = new();
                
                await Task.Delay(2000);
                Nav.NavigateTo("/");
            }
            else
            {
                message = "‚ùå " + string.Join("; ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            message = "‚ùå Error: " + ex.Message;
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
